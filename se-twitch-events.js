let fieldData,userCurrency,totalEvents=0,fadeOut;let SLTypes={"follower":"follow","cheer":"bits","tip":"donation","host":"host","raid":"raid","subscriber":"sub"};window.addEventListener('onEventReceived',function(obj){if(typeof obj.detail.event.itemId!=="undefined"){obj.detail.listener="redemption-latest"}
const listener=obj.detail.listener.split("-")[0];const event=obj.detail.event;event.type=listener;let tag=parseEvent(event);if(tag){let updateData={detail:{"priority":10,"from":event.name,"to":"","message":event.message,"payload":{"name":event.name,"priority":10},"name":event.name,"repeat":false,"platform":"twitch_account","type":SLTypes[listener],"hash":`${SLTypes[listener]}:${event.name}`,"read":false,"wotcCode":null,"tag":tag}};if(listener==="subscriber"){if(event.isGift){updateData.detail.months=1;updateData.detail.gifter=event.sender;updateData.detail.gifter=event.sender;updateData.detail.message=event.message;updateData.detail.hash+=":"+event.message;}else{updateData.detail.message=event.message;updateData.detail.months=event.amount;}
if(listener==='tip'||listener==='host'||listener==='raid'||listener==='cheer'){updateData.detail.amount=event.amount;}}
let eventData=new CustomEvent('onEventAdded',updateData);document.dispatchEvent(eventData);}});window.addEventListener('onWidgetLoad',function(obj){document.body.classList.add('widget-EventList');let recents=obj.detail.recents;recents.sort(function(a,b){return Date.parse(a.createdAt)-Date.parse(b.createdAt);});userCurrency=obj.detail.currency;fieldData=obj.detail.fieldData;fieldData.eventsLimit+=1;for(let i in fieldData){if(fieldData[i]==="yes")fieldData[i]=true;if(fieldData[i]==="no")fieldData[i]=false;}
let updateData={detail:{animation_speed:fieldData['animationSpeed'],background:fieldData['background'],flip_x:fieldData['flip_x']==="yes",flip_y:fieldData['flip_y']==="yes",font_family:fieldData['fontName'],font_size:fieldData['fontSize']+"px",max_events:fieldData['eventsLimit'],custom_json:{}},};for(let i in fieldData){updateData.detail.custom_json[i]=fieldData[i];}
let eventIndex;for(eventIndex=0;eventIndex<recents.length;eventIndex++){const event=recents[eventIndex];parseEvent(event,true);}
if(fieldData.fadeoutTime!==999){$("body").fadeTo("slow",0);}
let added=new CustomEvent('onLoad',updateData);document.dispatchEvent(added);setTimeout(()=>{let loaded=new CustomEvent('onEventsLoaded',updateData);document.dispatchEvent(loaded);},1500);});function parseEvent(event,historical=false){if(event.type==='follower'){if(fieldData.includeFollowers){return addEvent('twitch-follow','Follow',event.name,historical);}}else if(event.type==='redemption'){if(fieldData.includeRedemptions){return addEvent('redemption','Redeemed',event.name,historical);}}else if(event.type==='subscriber'){if(!fieldData.includeSubs)return;if(event.amount==='gift'){return addEvent('twitch-sub',`Sub gift`,event.name,historical);}else{return addEvent('twitch-sub',`Sub X${event.amount}`,event.name,historical);}}else if(event.type==='host'){if(fieldData.includeHosts&&fieldData.minHost<=event.amount){return addEvent('twitch-host',`Host ${event.amount.toLocaleString()}`,event.name,historical);}}else if(event.type==='cheer'){if(fieldData.includeCheers&&fieldData.minCheer<=event.amount){return addEvent('twitch-bit',`${event.amount.toLocaleString()} Bits`,event.name,historical);}}else if(event.type==='tip'){if(fieldData.includeTips&&fieldData.minTip<=event.amount){if(event.amount===parseInt(event.amount)){return addEvent('donation',event.amount.toLocaleString(fieldData.userLocale,{style:'currency',minimumFractionDigits:0,currency:userCurrency.code}),event.name,historical);}else{return addEvent('donation',event.amount.toLocaleString(fieldData.userLocale,{style:'currency',currency:userCurrency.code}),event.name,historical);}}}else if(event.type==='raid'){if(fieldData.includeRaids&&fieldData.minRaid<=event.amount){return addEvent('raid',`Raid ${event.amount.toLocaleString()}`,event.name,historical);}}
return false;}
function addEvent(type,text,username,historical){if(fieldData.fadeoutTime!==999&&!historical){$("body").fadeTo("slow",1);clearTimeout(fadeOut);console.log("Setting tiemr for "+fieldData.fadeoutTime*1000)
fadeOut=setTimeout(()=>{console.log("Fading out");$("body").fadeTo("slow",0);},fieldData.fadeoutTime*1000)}
totalEvents+=1;let row=$(template("eventlist_item",{from:username,tag:text.replace("\xA0"," "),eventType:type}));row.addClass("event");row.attr('id',`event${totalEvents}`)
$(".widget-EventList").prepend(row);if(1){removeEvent(fieldData.eventsLimit);}
return text.replace("\xA0"," ");}
function template(templateId,data){return document.getElementById(templateId).innerHTML.replace(/{(\w*)}/g,function(m,key){return data.hasOwnProperty(key)?data[key]:"";});}
function removeEvent(eventId){$("body .event:nth-child(n+"+(fieldData.eventsLimit+1)+")").animate({height:0,opacity:0},'slow',function(){$("body .event:nth-child(n+"+(fieldData.eventsLimit+1)+")").remove();});}